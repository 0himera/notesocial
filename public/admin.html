<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>NoteMe ‚Äî –ê–¥–º–∏–Ω–∫–∞</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background: #1c1c1e;
      color: #fff;
      min-height: 100vh
    }

    .container {
      max-width: 500px;
      margin: 0 auto;
      padding: 20px
    }

    header {
      padding: 16px 0;
      border-bottom: 1px solid #38383a;
      margin-bottom: 24px
    }

    h1 {
      font-size: 24px;
      font-weight: 600
    }

    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 24px
    }

    .tab {
      flex: 1;
      padding: 12px;
      background: #2c2c2e;
      border: none;
      color: #fff;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px
    }

    .tab.active {
      background: #ff9f0a;
      color: #000
    }

    .form-group {
      margin-bottom: 16px
    }

    label {
      display: block;
      font-size: 14px;
      color: #98989f;
      margin-bottom: 6px
    }

    input,
    textarea {
      width: 100%;
      padding: 12px;
      background: #2c2c2e;
      border: 1px solid #38383a;
      border-radius: 8px;
      color: #fff;
      font-size: 16px;
      font-family: inherit
    }

    input:focus,
    textarea:focus {
      outline: none;
      border-color: #ff9f0a
    }

    textarea {
      min-height: 150px;
      resize: vertical
    }

    .btn {
      width: 100%;
      background: #ff9f0a;
      color: #000;
      border: none;
      padding: 14px;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      font-weight: 500
    }

    .btn:hover {
      background: #ffb340
    }

    .btn:disabled {
      background: #48484a;
      cursor: not-allowed
    }

    .message {
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 16px;
      font-size: 14px
    }

    .message.success {
      background: #30d158;
      color: #000
    }

    .message.error {
      background: #ff453a;
      color: #fff
    }

    .back {
      color: #ff9f0a;
      text-decoration: none;
      font-size: 14px
    }

    #newUserForm,
    #newNoteForm {
      display: none
    }

    #newUserForm.active,
    #newNoteForm.active {
      display: block
    }
  </style>
</head>

<body>
  <div class="container">
    <header>
      <a href="./index.html" class="back">‚Üê –ù–∞–∑–∞–¥ –∫ –∑–∞–º–µ—Ç–∫–∞–º</a>
      <h1 style="margin-top:12px">üìù –î–æ–±–∞–≤–∏—Ç—å</h1>
    </header>

    <div id="messageBox"></div>

    <div class="tabs">
      <button class="tab active" onclick="showTab('note')">–ù–æ–≤–∞—è –∑–∞–º–µ—Ç–∫–∞</button>
      <button class="tab" onclick="showTab('user')">–ù–æ–≤—ã–π —é–∑–µ—Ä</button>
    </div>

    <!-- New Note Form -->
    <form id="newNoteForm" class="active" onsubmit="submitNote(event)">
      <div class="form-group">
        <label>ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
        <input type="text" id="noteUserId" placeholder="alice" required>
      </div>
      <div class="form-group">
        <label>–¢–µ–∫—Å—Ç –∑–∞–º–µ—Ç–∫–∏</label>
        <textarea id="noteText" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —á—Ç–æ-–Ω–∏–±—É–¥—å..." required></textarea>
      </div>
      <div class="form-group">
        <label>–ü–∞—Ä–æ–ª—å</label>
        <input type="password" id="notePassword" placeholder="–í–∞—à –ø–∞—Ä–æ–ª—å" required>
      </div>
      <button type="submit" class="btn">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
    </form>

    <!-- New User Form -->
    <form id="newUserForm" onsubmit="submitUser(event)">
      <div class="form-group">
        <label>–õ–æ–≥–∏–Ω (–ª–∞—Ç–∏–Ω–∏—Ü–µ–π)</label>
        <input type="text" id="newUserId" placeholder="ivan" pattern="[a-z0-9_]+" required>
      </div>
      <div class="form-group">
        <label>–ü–∞—Ä–æ–ª—å (–∑–∞–ø–æ–º–Ω–∏—Ç–µ!)</label>
        <input type="password" id="newUserPassword" placeholder="–ú–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤" minlength="6" required>
      </div>
      <button type="submit" class="btn">–°–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</button>
    </form>
  </div>

  <script>
    // Check URL params for pre-filled user
    const params = new URLSearchParams(location.search);
    if (params.get('user')) {
      document.getElementById('noteUserId').value = params.get('user');
    }

    // Tab switching
    function showTab(tab) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab')[tab === 'note' ? 0 : 1].classList.add('active');
      document.getElementById('newNoteForm').classList.toggle('active', tab === 'note');
      document.getElementById('newUserForm').classList.toggle('active', tab === 'user');
    }

    // SHA-256 hash function (pure JS, no crypto.subtle needed)
    function sha256(str) {
      function rightRotate(value, amount) {
        return (value >>> amount) | (value << (32 - amount));
      }

      const mathPow = Math.pow;
      const maxWord = mathPow(2, 32);
      let result = '';
      const words = [];
      const asciiBitLength = str.length * 8;

      // Initial hash values
      let hash = [0x6a09e667, 0xbb67ae85, 0x3c6ef372, 0xa54ff53a, 0x510e527f, 0x9b05688c, 0x1f83d9ab, 0x5be0cd19];

      // Round constants
      const k = [
        0x428a2f98, 0x71374491, 0xb5c0fbcf, 0xe9b5dba5, 0x3956c25b, 0x59f111f1, 0x923f82a4, 0xab1c5ed5,
        0xd807aa98, 0x12835b01, 0x243185be, 0x550c7dc3, 0x72be5d74, 0x80deb1fe, 0x9bdc06a7, 0xc19bf174,
        0xe49b69c1, 0xefbe4786, 0x0fc19dc6, 0x240ca1cc, 0x2de92c6f, 0x4a7484aa, 0x5cb0a9dc, 0x76f988da,
        0x983e5152, 0xa831c66d, 0xb00327c8, 0xbf597fc7, 0xc6e00bf3, 0xd5a79147, 0x06ca6351, 0x14292967,
        0x27b70a85, 0x2e1b2138, 0x4d2c6dfc, 0x53380d13, 0x650a7354, 0x766a0abb, 0x81c2c92e, 0x92722c85,
        0xa2bfe8a1, 0xa81a664b, 0xc24b8b70, 0xc76c51a3, 0xd192e819, 0xd6990624, 0xf40e3585, 0x106aa070,
        0x19a4c116, 0x1e376c08, 0x2748774c, 0x34b0bcb5, 0x391c0cb3, 0x4ed8aa4a, 0x5b9cca4f, 0x682e6ff3,
        0x748f82ee, 0x78a5636f, 0x84c87814, 0x8cc70208, 0x90befffa, 0xa4506ceb, 0xbef9a3f7, 0xc67178f2
      ];

      // Convert string to UTF-8 bytes
      str = unescape(encodeURIComponent(str));

      // Pre-processing
      let i, j;
      str += '\x80'; // Append bit '1' to message
      while (str.length % 64 - 56) str += '\x00';

      for (i = 0; i < str.length; i++) {
        j = str.charCodeAt(i);
        if (j >> 8) return; // ASCII check
        words[i >> 2] |= j << ((3 - i) % 4) * 8;
      }
      words[words.length] = ((asciiBitLength / maxWord) | 0);
      words[words.length] = (asciiBitLength);

      // Process each chunk
      for (j = 0; j < words.length;) {
        const w = words.slice(j, j += 16);
        const oldHash = hash.slice(0);

        for (i = 0; i < 64; i++) {
          // Expand message schedule
          if (i >= 16) {
            const s0 = rightRotate(w[i - 15], 7) ^ rightRotate(w[i - 15], 18) ^ (w[i - 15] >>> 3);
            const s1 = rightRotate(w[i - 2], 17) ^ rightRotate(w[i - 2], 19) ^ (w[i - 2] >>> 10);
            w[i] = (w[i - 16] + s0 + w[i - 7] + s1) | 0;
          }

          const S1 = rightRotate(hash[4], 6) ^ rightRotate(hash[4], 11) ^ rightRotate(hash[4], 25);
          const ch = (hash[4] & hash[5]) ^ ((~hash[4]) & hash[6]);
          const temp1 = (hash[7] + S1 + ch + k[i] + w[i]) | 0;
          const S0 = rightRotate(hash[0], 2) ^ rightRotate(hash[0], 13) ^ rightRotate(hash[0], 22);
          const maj = (hash[0] & hash[1]) ^ (hash[0] & hash[2]) ^ (hash[1] & hash[2]);
          const temp2 = (S0 + maj) | 0;

          hash = [(temp1 + temp2) | 0, hash[0], hash[1], hash[2], (hash[3] + temp1) | 0, hash[4], hash[5], hash[6]];
        }

        for (i = 0; i < 8; i++) {
          hash[i] = (hash[i] + oldHash[i]) | 0;
        }
      }

      for (i = 0; i < 8; i++) {
        for (j = 3; j >= 0; j--) {
          const b = (hash[i] >> (j * 8)) & 255;
          result += ((b < 16) ? '0' : '') + b.toString(16);
        }
      }
      return result;
    }

    // Show message
    function showMessage(text, isError = false) {
      const box = document.getElementById('messageBox');
      box.innerHTML = `<div class="message ${isError ? 'error' : 'success'}">${text}</div>`;
      setTimeout(() => box.innerHTML = '', 5000);
    }

    // Submit new note
    async function submitNote(e) {
      e.preventDefault();
      const btn = e.target.querySelector('button');
      btn.disabled = true;
      btn.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞...';

      try {
        const userId = document.getElementById('noteUserId').value.trim().toLowerCase();
        const text = document.getElementById('noteText').value.trim();
        const password = document.getElementById('notePassword').value;
        const passwordHash = sha256(password);

        const res = await fetch('/api/post', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'addNote', userId, text, passwordHash })
        });

        const data = await res.json();
        if (!res.ok) throw new Error(data.error || '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');

        showMessage('‚úÖ –ó–∞–º–µ—Ç–∫–∞ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–∞! –°—Ç—Ä–∞–Ω–∏—Ü–∞ –æ–±–Ω–æ–≤–∏—Ç—Å—è —á–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥.');
        document.getElementById('noteText').value = '';
      } catch (err) {
        showMessage(err.message, true);
      } finally {
        btn.disabled = false;
        btn.textContent = '–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å';
      }
    }

    // Submit new user
    async function submitUser(e) {
      e.preventDefault();
      const btn = e.target.querySelector('button');
      btn.disabled = true;
      btn.textContent = '–°–æ–∑–¥–∞–Ω–∏–µ...';

      try {
        const userId = document.getElementById('newUserId').value.trim().toLowerCase();
        const password = document.getElementById('newUserPassword').value;
        const passwordHash = sha256(password);

        const res = await fetch('/api/post', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'createUser', userId, passwordHash })
        });

        const data = await res.json();
        if (!res.ok) throw new Error(data.error || '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');

        showMessage(`‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å "${userId}" —Å–æ–∑–¥–∞–Ω! –ó–∞–ø–æ–º–Ω–∏—Ç–µ –ø–∞—Ä–æ–ª—å: –æ–Ω –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è –¥–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –∑–∞–º–µ—Ç–æ–∫.`);
        e.target.reset();
      } catch (err) {
        showMessage(err.message, true);
      } finally {
        btn.disabled = false;
        btn.textContent = '–°–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è';
      }
    }
  </script>
</body>

</html>